<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Markets - Currents</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            background: #000;
            color: #fff;
        }
        
        /* Currents Brand Colors */
        :root {
            --currents-red: #FF5757;
        }
        
        /* Hide scrollbar but keep functionality */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-black/90 backdrop-blur-md border-b border-gray-800">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Back Button -->
            <a href="/" class="p-2 hover:bg-gray-800 rounded-lg transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            
            <!-- Title -->
            <h1 class="text-lg font-bold">All Markets</h1>
            
            <!-- Menu Button -->
            <button onclick="document.getElementById('menu-modal').style.display='flex';" class="p-2 hover:bg-gray-800 rounded-lg transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- Category Filter Tags (Horizontal Scroll) -->
        <div class="overflow-x-auto scrollbar-hide px-4 pb-3">
            <div class="flex gap-2 w-max">
                <!-- All Markets (Black & White) -->
                <button onclick="filterCategory('all')" 
                        id="filter-all"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-white text-black ring-2 ring-white">
                    All Markets
                </button>
                
                <!-- Category Tags (Existing Design) -->
                <button onclick="filterCategory('Sports')" 
                        id="filter-Sports"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-green-400 text-black">
                    Sports
                </button>
                
                <button onclick="filterCategory('Economics')" 
                        id="filter-Economics"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-blue-400 text-black">
                    Economics
                </button>
                
                <button onclick="filterCategory('Crypto')" 
                        id="filter-Crypto"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-yellow-400 text-black">
                    Crypto
                </button>
                
                <button onclick="filterCategory('Politics')" 
                        id="filter-Politics"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-orange-400 text-black">
                    Politics
                </button>
                
                <button onclick="filterCategory('Crime')" 
                        id="filter-Crime"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-red-400 text-black">
                    Crime
                </button>
                
                <button onclick="filterCategory('Entertainment')" 
                        id="filter-Entertainment"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-pink-400 text-black">
                    Entertainment
                </button>
                
                <button onclick="filterCategory('Technology')" 
                        id="filter-Technology"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-purple-400 text-black">
                    Technology
                </button>
                
                <button onclick="filterCategory('Culture')" 
                        id="filter-Culture"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-indigo-400 text-black">
                    Culture
                </button>
                
                <button onclick="filterCategory('World')" 
                        id="filter-World"
                        class="category-filter px-3 py-1 rounded-xl text-xs font-medium uppercase tracking-wide whitespace-nowrap transition-all bg-cyan-400 text-black">
                    World
                </button>
            </div>
        </div>
    </header>
    
    <!-- Markets Container (Scrollable) -->
    <div id="markets-scroll" class="pt-[140px] pb-20 overflow-y-auto h-screen">
        <div class="space-y-3 px-4">
            <!-- Markets will be inserted here -->
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-currents-red"></div>
        </div>
        
        <!-- No More Markets -->
        <div id="no-more" class="text-center py-8 text-gray-500 hidden">
            No more markets
        </div>
    </div>
    
    <!-- Menu Modal (Same as feed_mobile.html) -->
    <div id="menu-modal" class="fixed inset-0 bg-black/95 backdrop-blur-sm z-50 items-start justify-center pt-16 hidden" style="display: none;" onclick="this.style.display='none';">
        <div class="bg-gray-900 rounded-2xl max-w-md w-full mx-4 p-6 border border-gray-700" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Menu</h2>
                <button onclick="document.getElementById('menu-modal').style.display='none'; return false;" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-3">
                <a href="/" class="flex items-center gap-4 p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition">
                    <svg class="w-6 h-6 text-currents-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="font-bold">Back to Feed</div>
                        <div class="text-sm text-gray-400">Personalized feed</div>
                    </div>
                </a>
                
                <a href="/?desktop=1" class="flex items-center gap-4 p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition">
                    <svg class="w-6 h-6 text-currents-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="font-bold">Desktop View</div>
                        <div class="text-sm text-gray-400">Full features</div>
                    </div>
                </a>
            </div>
        </div>
    </div>
    
    <script>
    // State
    let currentCategory = 'all';
    let currentOffset = 0;
    let loading = false;
    let hasMore = true;
    const BATCH_SIZE = 60;
    
    const USER_KEY = '{{ user_key }}';
    
    // Get references
    const scrollContainer = document.getElementById('markets-scroll');
    const marketsContainer = scrollContainer.querySelector('.space-y-3');
    const loadingEl = document.getElementById('loading');
    const noMoreEl = document.getElementById('no-more');
    
    // Category filter
    function filterCategory(category) {
        if (loading) return;
        
        currentCategory = category;
        currentOffset = 0;
        hasMore = true;
        
        // Update button states
        document.querySelectorAll('.category-filter').forEach(btn => {
            if (btn.id === `filter-${category}`) {
                btn.classList.add('ring-2', 'ring-white');
            } else {
                btn.classList.remove('ring-2', 'ring-white');
            }
        });
        
        // Clear and reload
        marketsContainer.innerHTML = '';
        noMoreEl.classList.add('hidden');
        loadMarkets();
    }
    
    // Load markets
    async function loadMarkets() {
        if (loading || !hasMore) return;
        
        loading = true;
        loadingEl.classList.remove('hidden');
        
        try {
            const response = await fetch('/api/markets/feed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_key: USER_KEY,
                    category: currentCategory,
                    offset: currentOffset,
                    limit: BATCH_SIZE
                })
            });
            
            const data = await response.json();
            
            // Render markets
            data.markets.forEach(market => {
                marketsContainer.appendChild(createMarketCard(market));
            });
            
            hasMore = data.has_more;
            currentOffset += BATCH_SIZE;
            
            if (!hasMore) {
                noMoreEl.classList.remove('hidden');
            }
            
        } catch (err) {
            console.error('Failed to load markets:', err);
        } finally {
            loading = false;
            loadingEl.classList.add('hidden');
        }
    }
    
    // Create market card
    function createMarketCard(market) {
        const card = document.createElement('div');
        card.className = 'bg-gray-900 rounded-xl overflow-hidden border border-gray-800';
        
        // Get category color class
        const categoryColors = {
            'Sports': 'bg-green-400 text-black',
            'Economics': 'bg-blue-400 text-black',
            'Crypto': 'bg-yellow-400 text-black',
            'Politics': 'bg-orange-400 text-black',
            'Crime': 'bg-red-400 text-black',
            'Entertainment': 'bg-pink-400 text-black',
            'Technology': 'bg-purple-400 text-black',
            'Culture': 'bg-indigo-400 text-black',
            'World': 'bg-cyan-400 text-black'
        };
        const categoryColor = categoryColors[market.category] || 'bg-gray-400 text-black';
        
        // Generate belief gradient
        const prob = market.probability;
        let gradient;
        if (prob > 0.75) {
            gradient = "linear-gradient(to right, #F59E0B 0%, #10B981 15%, #10B981 60%, #22C55E 100%)";
        } else if (prob > 0.6) {
            gradient = "linear-gradient(to right, #EF4444 0%, #F59E0B 25%, #10B981 60%, #22C55E 100%)";
        } else if (prob > 0.4) {
            gradient = "linear-gradient(to right, #EF4444 0%, #F59E0B 20%, #10B981 40%, #F59E0B 60%, #EF4444 80%, #F59E0B 100%)";
        } else if (prob > 0.25) {
            gradient = "linear-gradient(to right, #10B981 0%, #F59E0B 30%, #EF4444 70%, #DC2626 100%)";
        } else {
            gradient = "linear-gradient(to right, #F59E0B 0%, #EF4444 20%, #EF4444 60%, #DC2626 100%)";
        }
        
        card.innerHTML = `
            <a href="/market/${market.market_id}" class="block group">
                <!-- Image Section -->
                <div class="relative h-40">
                    ${market.image_url ? `
                        <img src="${market.image_url}" 
                             alt="${market.title}"
                             class="w-full h-full object-cover group-active:scale-105 transition"
                             onerror="this.style.display='none'">
                    ` : ''}
                    
                    <!-- Gradient (Darker Bottom) -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 right-0 h-1/2 bg-gradient-to-t from-black/85 to-transparent"></div>
                    
                    
                    <!-- Category Badge -->
                    <div class="absolute top-2 left-2">
                        <span class="px-2.5 py-1 ${categoryColor} text-[9px] font-medium rounded-lg uppercase tracking-wide backdrop-blur-sm">
                            ${market.category || 'Other'}
                        </span>
                    </div>
                    
                    <!-- Probability Badge -->
                    <div class="absolute top-2 right-2 px-2 py-1 bg-black/90 backdrop-blur-lg rounded-lg border border-white/10">
                        <div class="text-lg font-bold">${Math.round(market.probability * 100)}%</div>
                        <div class="text-[8px] font-semibold ${market.probability > 0.5 ? 'text-green-500' : 'text-red-500'}">Lean "${market.probability > 0.5 ? 'Yes' : 'No'}"</div>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div class="p-3">
                    <!-- Title with Heart -->
                    <div class="flex items-start gap-2 mb-2">
                        <h3 class="text-sm font-semibold flex-1 line-clamp-2">${market.title}</h3>
                        <button onclick="likeMarket('${market.market_id}', this); event.preventDefault(); event.stopPropagation();" 
                                class="like-btn flex-shrink-0 group/like"
                                data-market-id="${market.market_id}">
                            <svg class="w-4 h-4 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path class="text-gray-400 group-hover/like:text-red-400 transition" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Belief Currents with Gradient -->
                    <div class="bg-gray-800 rounded-lg p-2 mb-2">
                        <div class="text-[8px] text-gray-400 uppercase tracking-wider font-semibold mb-1">CURRENTS</div>
                        
                        <!-- Probability Bar with Gradient -->
                        <div class="h-1 bg-gray-700 rounded-full overflow-hidden mb-1 relative">
                            <div class="absolute inset-0 rounded-full" style="background: ${gradient}"></div>
                        </div>
                        
                        <!-- Percentages -->
                        <div class="flex justify-between text-[8px]">
                            <span class="text-green-500 font-semibold">${Math.round(market.probability * 100)}%</span>
                            <span class="text-red-500 font-semibold">${Math.round((1 - market.probability) * 100)}%</span>
                        </div>
                    </div>
                    
                    <!-- CTA Button -->
                    <button class="w-full bg-currents-red text-white font-semibold py-2 px-4 rounded-lg transition text-sm active:scale-95">
                        View Market
                    </button>
                </div>
            </a>
        `;
        
        return card;
    }
    
    // Infinite scroll
    scrollContainer.addEventListener('scroll', () => {
        const scrollPos = scrollContainer.scrollTop + scrollContainer.clientHeight;
        const scrollHeight = scrollContainer.scrollHeight;
        
        // Load more when 200px from bottom
        if (scrollPos > scrollHeight - 200 && !loading && hasMore) {
            loadMarkets();
        }
    });
    
    // Initial load
    filterCategory('all');
    </script>
</body>
</html>
